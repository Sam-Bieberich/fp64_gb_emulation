# CMake & Run Instructions

Converted from `ozIMMU/cmake_instructions.txt`.

This file documents the CMake flags, build steps, environment variables, and run examples used on Vista (CUDA 12.4) and GB10 (CUDA 13.0) setups.

---

## CMake build (Vista, CUDA 12.4)

Run the following from the `build` directory:

```bash
cd build
rm -rf *
cmake -DBUILD_TEST=ON \
      -DCMAKE_CUDA_COMPILER=$(which nvcc) \
      -DCUDAToolkit_ROOT=/opt/apps/nvidia_math/12.4 \
      ..
make -j4
ls -lh main.test
```

The final `ls -lh` should return the permissions and location of `main.test` if the build succeeded.

### Set runtime environment and example run

Before running, set the cuBLAS library path and the compute mode:

```bash
# Set library path for cuBLAS
export LD_LIBRARY_PATH=/opt/apps/nvidia_math/12.4/targets/sbsa-linux/lib:$LD_LIBRARY_PATH

# Set compute mode (default for tests)
export OZIMMU_COMPUTE_MODE=fp64_int8_9

# Run a single-file dgemm test
./main.test normal01 dgemm seq 1024 1024 1 fp64_int8_3 fp64_int8_9 fp64_int8_18 dgemm
```

### More run examples

Compare all available split levels (3, 6, 9, 12, 15, 18):

```bash
./main.test normal01 dgemm seq 2048 2048 1 \
    fp64_int8_3 fp64_int8_6 fp64_int8_9 fp64_int8_12 fp64_int8_15 fp64_int8_18 dgemm
```

Compare across multiple matrix sizes (test sizes from 1024 to 4096 stepping by 1024):

```bash
./main.test normal01 dgemm seq 1024 4096 1024 fp64_int8_9 dgemm
```

Compare with FP32 (`sgemm`) as well:

```bash
./main.test normal01 dgemm seq 2048 2048 1 fp64_int8_9 dgemm sgemm
```

Test on ill-conditioned matrices (exponential distribution):

```bash
./main.test exp dgemm seq 1024 1024 1 fp64_int8_3 fp64_int8_9 fp64_int8_18 dgemm
```

Save results to CSV:

```bash
./main.test normal01 dgemm seq 1024 4096 1024 \
    fp64_int8_3 fp64_int8_9 fp64_int8_18 dgemm > comparison_results.csv
```

Test syntax reminder:

```text
./main.test <input_dist> <ref_impl> <size_mode> <m_start> <m_end> <m_interval> <mode1> [mode2 ...]
```

---

## GB10 build & run notes (CUDA 13.0)

If Vista setup has issues, try building against the GB10 CUDA install instead. Example commands:

```bash
cd build
rm -rf *
cmake -DBUILD_TEST=ON \
      -DCMAKE_CUDA_COMPILER=$(which nvcc) \
      -DCUDAToolkit_ROOT=/usr/local/cuda \
      ..
make -j4
ls -lh main.test
```

On GB10, library paths may differ:

```bash
# Set library path for cuBLAS (GB10)
export LD_LIBRARY_PATH=/usr/local/cuda-13.0/targets/sbsa-linux/lib:$LD_LIBRARY_PATH

# Set compute mode (default for tests)
export OZIMMU_COMPUTE_MODE=fp64_int8_9

# Now run the same tests as before. Example:
./main.test normal01 dgemm seq 1024 1024 1 fp64_int8_3 fp64_int8_9 fp64_int8_18 dgemm
```

Notes:
- On GB10 the performance may be lower but accuracy generally improves (except at very low slice counts, e.g., 3 slices).
- If you encounter unexpected runtime behaviour on Vista, verify that `CUDAToolkit_ROOT` and `LD_LIBRARY_PATH` point to the correct CUDA installation used to build and run.

---

## Quick checklist

- Ensure `nvcc` used by CMake matches the CUDA libraries in `LD_LIBRARY_PATH`.
- Use `-DCUDAToolkit_ROOT` to point CMake at the correct CUDA installation.
- After building, confirm `main.test` exists with `ls -lh main.test`.
- Set `OZIMMU_COMPUTE_MODE` to the desired mode before running tests.
- Use the example commands above to compare split levels, sizes, and precisions.

---

## Contact / Notes

This file was generated by converting the plain text instructions in `ozIMMU/cmake_instructions.txt` to Markdown for easier reading and use in this repository.
